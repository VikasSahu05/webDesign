PushWidgets.WFUpload=new Class({Implements:[Events,Options],options:{className:"file-attachment",max_image_side:2400,jpg_quality:.85,maxUploads:10,maxFileSize:15728640,maxResizableFileSize:15728640,maxTotalUploadSize:15728640,closeIcon:'<i class="fa fa-trash"></i>'},bound:null,boundForm:null,uploadElements:null,initialize:function(e,i){if("undefined"==typeof FileReader)return!1;this.setOptions(i),this.bound={addFiles:this.addFiles.bind(this),_resizeImage:this._resizeImage.bind(this)},this.boundForm=$(e),this.uploadElements=$(e).getElements('[type="file"]'),this.uploadElements.each(function(e){e.set("data-fieldname",e.get("name")),e.removeProperty("name");var i=new Element("label",{class:this.options.className+"-label"}).wraps(e),t=new Element("div",{class:this.options.className+"-wrap"}).wraps(i),i=e.hasAttribute("multiple")?(e.hasAttribute("data-max-files")||e.set("data-max-files",10),new Element("a",{class:"button",html:'Attach Files <i class="fa fa-plus"></i>'}).inject(t,"bottom")):(e.set("data-max-files",1),new Element("a",{class:"button",html:'Attach File <i class="fa fa-plus"></i>'}).inject(t,"bottom"));i.addEvent("click",function(){e.click()});var a=new Element("div",{class:this.options.className+"-thumbnails"}).inject(t,"bottom").addEvent("click:relay(a.close)",function(e,i){$(i).getParent("div").dispose()});e.addEvent("change",function(e){this.bound.addFiles(e.target,a)}.bind(this))}.bind(this))},addFiles:function(l,o){if(Array.each(l.files,function(s){if(0!==this.options.maxUploads&&this.countAllFiles()==this.options.maxUploads)return o.appendHTML('<div title = "No more than '+this.options.maxUploads+' files can be uploaded at a time using this form."><div class="preview error"></div><a class="close">'+this.options.closeIcon+"</a></div>"),!1;var e=l.get("data-max-files")||1;if(o.getElements("input[name]").length>=e)return o.appendHTML('<div title = "No more than '+e+' file(s) can be uploaded at a time using this field."><div class="preview error"></div><a class="close">'+this.options.closeIcon+"</a></div>"),!1;e=new FileReader;e.readAsDataURL(s),e.onload=function(e){var i,t,a=s.name.replace(/[&<>'"]/g,function(e){return{"&":"&amp;","'":"&apos;",'"':"&quot;","<":"&lt;",">":"&gt;"}[e]||e}).replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");s.type.match(/(application\/.*(word|excel|rtf|pdf).*)|text\/.*(plain|excel).*/i)?s.size>=this.options.maxFileSize?o.appendHTML('<div title = "'+a+' is too large to accept." data-nice-filesize= "Too Large"><div class="preview error"></div><a class="close">'+this.options.closeIcon+"</a></div>"):s.size+this.countTotalFileSize()>=this.options.maxTotalUploadSize?o.appendHTML('<div title = "The combined size of all your files is too large to accept." data-nice-filesize= "Too Large"><div class="preview error"></div><a class="close">'+this.options.closeIcon+"</a></div>"):o.appendHTML('<div title = "'+a+'" data-filesize="'+s.size+'" data-nice-filesize= "'+(s.size/1048576).toFixed(2)+'MB"><div class="preview doc"></div><a class="close">'+this.options.closeIcon+'</a><input type="hidden" name="'+l.get("data-fieldname")+'[]" value="'+a+"|"+e.target.result+'"></div>'):s.type.match(/image\/(png|jpe?g|gif)/i)?s.size>=this.options.maxResizableFileSize?o.appendHTML('<div title = "'+a+' is too large to accept." data-nice-filesize= "Too Large"><div class="preview error"></div><a class="close">'+this.options.closeIcon+"</a></div>"):((i=new Image).src=e.target.result,t=Elements.from('<div title = "Processing '+a+'" data-nice-filesize=""><div class="preview" style="background-color: #ccc;"></div></div>')[0].inject(o,"bottom"),$(i).addEvent("load",function(){var e=this.bound._resizeImage(i,this.options.max_image_side,s.type);t.dispose(),e.length+this.countTotalFileSize()>=this.options.maxTotalUploadSize?o.appendHTML('<div title = "The combined size of all your files is too large to accept." data-nice-filesize= "Too Large"><div class="preview error"></div><a class="close">'+this.options.closeIcon+"</a></div>"):Elements.from('<div title = "'+a+'" data-filesize="'+e.length+'" data-nice-filesize= "'+(e.length/1048576).toFixed(1)+'MB"><div class="preview" style="background-image: url('+e+');"></div><a class="close">'+this.options.closeIcon+'</a><input type="hidden" name="'+l.get("data-fieldname")+'[]" value="'+a+"|"+e+'"></div>')[0].inject(o,"bottom"),i=null}.bind(this))):o.appendHTML('<div title = "'+a+' is not a supported file type."><div class="preview error"></div><a class="close">'+this.options.closeIcon+"</a></div>")}.bind(this)}.bind(this)),l.set("value",null),0<l.files.length)throw"Assertion Failed: File input still contains files."},countAllFiles:function(){return this.boundForm.getElements("."+this.options.className+"-thumbnails input[name]").length},countTotalFileSize:function(){var e=this.boundForm.getElements("."+this.options.className+"-thumbnails [data-filesize]"),i=0;return e.each(function(e){i+=Math.floor(e.get("data-filesize"))}),i},_resizeImage:function(e,i,t){var a=document.createElement("canvas"),i=function(e,i,t){t=Math.max(e/t,i/t);return 1<t?{w:e/t,h:i/t}:{w:e,h:i}}(e.width,e.height,i);return a.width=i.w,a.height=i.h,a.getContext("2d").drawImage(e,0,0,i.w,i.h),a.toDataURL({"image/jpeg":"image/jpeg","image/png":"image/png","image/gif":"image/png"}[t]||"image/jpeg",this.options.jpg_quality)}});