!function(e,n){"use strict";PushWidgets.WFCarouselLoop=new Class({Implements:[Events,Options],wrap:null,container:null,elements:null,currentIndex:0,elementCount:null,timer:null,dragInstance:{},options:{adaptHeight:!0,autoPlay:!1,dragThreshold:20,interval:5e3,nextClicker:"~ .car-next",overflowStyle:"hidden",prevClicker:"~ .car-prev",startIndex:0,thumbnailHolder:"~ .car-thumbs",draggingEffect:function(t){return t},draggingEffectEnd:function(){}},initialize:function(t,e){this.container=$(t).addClass("carousel loop"),this.container.getAttribute("data-carousel-setup")&&(e=JSON.parse(this.container.getAttribute("data-carousel-setup"))),this.container.getAttribute("data-setup-options")&&(e=JSON.parse(this.container.getAttribute("data-setup-options"))),this.setOptions(e),this.currentIndex=this.options.startIndex,this.setupCarousel(),this.layoutElements(),this.setCurrentIndex(this.currentIndex),this.options.nextClicker&&this.wrap.getElements(this.options.nextClicker).addEvent("click",this.next.bind(this)),this.options.prevClicker&&this.wrap.getElements(this.options.prevClicker).addEvent("click",this.prev.bind(this))},setupCarousel:function(){if(this.initialised)return this;this.wrap=new Element("div",{class:"carousel-wrap"}).setStyles({display:"block",overflow:this.options.overflowStyle,margin:0,padding:0}).wraps(this.container),e.addEvent("resize",this.layoutElements.bind(this).debounce(50,!1)),this.dragInstance=new Drag(this.container,{modifiers:{x:"x-drag-value",y:""},snap:this.options.dragThreshold,preventDefault:!1,unDraggableTags:["button","input","textarea","select","option"]});var t=function(t){Math.abs(this.dragInstance.value.now.x)>this.options.dragThreshold&&(t.preventDefault(),t.stopPropagation())}.bind(this);return this.container.addEvents({click:t}),this.container.setStyle("cursor","grab"),this.dragInstance.addEvents({start:function(){this.container.addClass("dragging"),this.container.setStyle("cursor","grabbing"),this.dragging=!0,this.dragfunc=null}.bind(this),drag:function(){null!==this.dragfunc&&PushWidgets.cancelAnimFrame(this.dragfunc),this.dragfunc=PushWidgets.requestAnimFrame(this.doDrag,this)}.bind(this),complete:function(t,e){this.dragging=!1,this.dragfunc=null,this.container.removeClass("dragging"),this.container.setStyle("cursor","grab");var n=this.dragInstance.value.now.x;parseInt(n)<-this.options.dragThreshold?(e.preventDefault(),this.next()):parseInt(n)>this.options.dragThreshold?(e.preventDefault(),this.prev()):this.setCurrentIndex(this.currentIndex),this.container.setStyle("x-drag-value",0),this.options.draggingEffectEnd&&this.options.draggingEffectEnd.bind(this)(this.elements,this.wrap)}.bind(this)}),null===this.elementCount&&(this.elementCount=this.container.getChildren().length),this.options.thumbnailHolder&&(this.thumbnailHolder=this.wrap.getElements(this.options.thumbnailHolder)[0],this.thumbnailHolder&&(this.thumbnailHolder.addClass("car-thumbs").addEvent("click:relay(span)",function(t,e){this.setCurrentIndex(this.thumbnailHolder.getChildren().indexOf(e))}.bind(this)),0==this.thumbnailHolder.getChildren().length&&this.thumbnailHolder.set("html","<span></span>".repeat(this.elementCount)))),this.initialised=!0,this},doDrag:function(){var t;0!=this.dragging&&(t=this.dragInstance.value.now.x,this.container.setStyle("transform","translate3d("+(-this.wrap.getWidth()*this.currentIndex+t)+"px, 0, 0)"),this.container.setStyle("msTransform","translate("+(-this.wrap.getWidth()*this.currentIndex+t)+"px, 0)"),this.container.setStyle("-webkit-transform","translate3d("+(-this.wrap.getWidth()*this.currentIndex+t)+"px,0,0)"),this.options.draggingEffect&&this.options.draggingEffect.bind(this)(t))},layoutElements:function(){var t=this.wrap.measure(function(){return this.getSize()});this.dragInstance.setOptions({limit:{x:[.75*-t.x,.75*t.x],y:[]}});var e=this.container.getChildren();if(0==e.length)return!1;if(this.wrap.setAttribute("data-slide-count",this.elementCount),e.length<5)for(var n=Math.ceil(5/this.elementCount)-1,i=0;i<n;i++)for(var s=0;s<this.elementCount;s++)$(e[s]).clone().inject(this.container,"bottom");this.elements=this.container.getChildren(),this.elements.setStyle("width","100%"),this.elements.each(function(t,e){t.setAttribute("data-idx",e%this.elementCount+1),t.setStyles({position:"absolute",top:"0",left:100*e+"%"}),this.setCurrentIndex(this.currentIndex)}.bind(this));t=this.elements[this.translateIndex(this.currentIndex)].measure(function(){return parseInt(this.getHeight())});this.wrap.setStyle("height",t+"px")},translateIndex:function(t){return t<0?(this.elements.length-Math.abs(t)%this.elements.length)%this.elements.length:t%this.elements.length},getCurrentBaseIndex:function(){return parseInt(this.currentIndex/this.elementCount)*this.elementCount},setCurrentIndex:function(t){"next"==t?this.currentIndex++:"prev"==t?this.currentIndex--:this.currentIndex=this.getCurrentBaseIndex()+this.translateIndex(parseInt(t));for(var e=-Math.floor(this.elements.length/2);e<=Math.floor(this.elements.length/2);e++)this.elements[this.translateIndex(this.currentIndex+e)].setStyles({left:(this.currentIndex+e)*this.wrap.getWidth()+"px"});this.wrap.setAttribute("data-current-slide",this.translateIndex(this.currentIndex)%this.elementCount+1),this.container.setStyle("transform","translate3d("+-this.wrap.getWidth()*this.currentIndex+"px, 0, 0)"),this.container.setStyle("msTransform","translate("+-this.wrap.getWidth()*this.currentIndex+"px, 0)"),this.container.setStyle("-webkit-transform","translate3d("+-this.wrap.getWidth()*this.currentIndex+"px,0,0)"),this.options.adaptHeight&&(t=this.elements[this.translateIndex(this.currentIndex)].measure(function(){return this.getHeight()}),this.wrap.setStyle("height",parseInt(t)+"px"))},next:function(){this.setCurrentIndex("next"),null!==this.timer&&this.stop()},prev:function(){this.setCurrentIndex("prev"),null!==this.timer&&this.stop()},play:function(t){this.timer=this.autoPlay.periodical(t||this.options.interval,this)},autoPlay:function(){this.setCurrentIndex("next")},stop:function(){clearInterval(this.timer),this.timer=null},start:function(){this.play()}.bind(this)}),PushWidgets.WFCarouselLoop.attach=function(t){t=t||n.body,$(t).getElements('[data-ui-role="carouselloop"]').each(function(t){new PushWidgets.WFCarouselLoop(t),t.set("data-ui-role",null)})}}(window,document);