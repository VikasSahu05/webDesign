!function(s,n){"use strict";PushWidgets.WFSelect=new Class({Implements:[Events,Options],Binds:["keydownEvent","blurEvent","keyupEvent","getSuggestions","positionDropdown","createListItem"],options:{className:"wfselect tagbox",placeholder:""},inputElement:null,currentValue:null,parentForm:null,wrap:null,id:null,tags:[],dropdownList:null,xhrInstance:null,cache:[],optionList:[],optionNodes:[],selectedOptionNode:null,value:null,initialize:function(t,e){if(void 0===t||"select"!=t.tagName.toLowerCase())return!1;this.setOptions(e),t.hasAttribute("data-setup-options")&&this.setOptions(JSON.parse(t.getAttribute("data-setup-options"))),this.selectElement=t,this.parentForm=this.selectElement.getParent("form")||null,this.wrap=new Element("div",{id:this.id,class:this.options.className,styles:{position:"static",overflow:"visible"}}).wraps(this.selectElement),this.currentValue=new Element("div",{class:this.options.className+"-value",text:""}).inject(this.wrap,"bottom"),this.inputElement=new Element("input",{type:"hidden",name:this.selectElement.name}).inject(this.wrap,"bottom"),this.selectElement.removeAttribute("name"),this.dropdownList=new Element("ul",{class:this.options.className+"-listbox",styles:{display:"none"}}).inject(this.wrap,"bottom"),this.selectElement.getElements("option").each(function(t){var e=t.value||null,i=t.get("text")||e||null;t.selected&&t.disabled?this.options.placeholder=t.get("text"):(this.optionList.push(e),this.optionNodes.push(this.createListItem(e,i,t.getAttribute("style")).inject(this.dropdownList,"bottom")),t.selected&&(this.value=e))}.bind(this)),this.dropdownList.addEvent("click:relay(li[data-value])",function(t,e){t.stopPropagation(),this.selectOption(e)}.bind(this)),this.positionDropdown(),this.dropdownList.addEvent("mouseenter:relay(li[data-value])",function(t,e){e.getSiblings().removeClass("selected"),e.addClass("selected")}),this.dropdownList.addEvent("mouseleave:relay(li[data-value])",function(t,e){e.removeClass("selected")}),this.selectElement.destroy(),this.selectOption(null,this.value),this.wrap.setAttribute("tabindex","0"),this.wrap.addEvent("keydown",this.keydownEvent),this.wrap.addEvent("keyup",this.keyupEvent),this.wrap.addEvent("blur",this.blurEvent),this.wrap.addEvent("click",this.getSuggestions),s.addEvent("resize",this.positionDropdown)},keydownEvent:function(t){var e;if(["down","space"].contains(t.key)&&(t.stopPropagation(),t.preventDefault(),this.dropdownList.isVisible()||this.positionDropdown(!0)),this.dropdownList.isVisible()&&["up","down","tab","enter"].contains(t.key)&&((e=this.highlightOption(t.key))||this.selectOption(e),this.dropdownList.isVisible()&&("tab"!=t.key&&"enter"!=t.key||(this.selectOption(e),this.positionDropdown(!1)),t.stop())),"esc"==t.key)return!1},keyupEvent:function(t){!["enter","down","space"].contains(["enter","down","space"])||(t.stopPropagation(),t.preventDefault(),this.dropdownList.isVisible())?["up","down","left","right","tab","enter","esc"].contains(t.key)||this.getSuggestions():this.positionDropdown(!0)},blurEvent:function(){this.positionDropdown(!1)}.debounce(100,!1),selectOption:function(t,e){if(null===t){if(""!=this.options.placeholder&&!this.optionList.contains(e))return t=null,this.currentValue.set("text",this.options.placeholder),this.currentValue.addClass("placeholder"),null;t=this.optionNodes[0]}else e=t.getAttribute("data-value");this.inputElement.value=e,this.dropdownList.getChildren("[data-value]").set("data-selected",null);t=this.dropdownList.getElements('>[data-value="'+e+'"]');return t&&t.set("data-selected",!0),this.currentValue.set("text",t.get("text")),this.currentValue.removeClass("placeholder"),this.positionDropdown(!1),this.fireChangeEvents("change",[this.value,t]),e},fireChangeEvents:function(t,e){this.fireEvent("change",[t,e]),this.parentForm.fireEvent("change")},highlightOption:function(e){if(0==this.optionNodes.length)return!1;if(1==this.optionNodes.length)return this.optionNodes[0];var i=!1;this.optionNodes.each(function(t){!i&&t.hasClass("selected")&&("up"==e&&(t.removeClass("selected"),i=null===t.getPrevious("[data-value]")?t||this.optionNodes.getFirst("[data-value]"):t.getPrevious("[data-value]")),"down"==e&&(t.removeClass("selected"),i=null===t.getNext("[data-value]")?t||this.optionNodes.getFirst("[data-value]"):t.getNext("[data-value]")),"tab"!=e&&"enter"!=e||(i=t))}),(i=i||this.optionNodes[0]).addClass("selected");var t=i.getPosition().y-this.dropdownList.getPosition().y+this.dropdownList.getScroll().y;return t<this.dropdownList.getHeight()-i.getHeight()?t<this.dropdownList.getHeight()/2?this.dropdownList.scrollTo(0,0):this.dropdownList.scrollTo(0,t-i.getHeight()):t>this.dropdownList.getHeight()-i.getHeight()&&this.dropdownList.scrollTo(0,t-2*i.getHeight()),i},getSuggestions:function(t){return t&&"click"==t.type&&this.dropdownList.isVisible()?this.positionDropdown(!1):this.positionDropdown(!0),this.options},positionDropdown:function(t){var e=this.wrap.getBoundingClientRect(),i=this.dropdownList.measure(function(){return this.getSize()});this.dropdownList.setStyle("width",e.width+"px"),e.top+e.height+i.y<(s.innerHeight||n.documentElement.clientHeight)?this.dropdownList.position({relativeTo:this.wrap,position:"bottomLeft",edge:"topLeft"}):this.dropdownList.position({relativeTo:this.wrap,position:"topLeft",edge:"bottomLeft"}),t?this.dropdownList.setStyles({display:"block",visibility:"visible"}):this.dropdownList.setStyles({display:"none",visibility:"hidden"})},setValue:function(t){return this.highlightOption(null,t)},getValue:function(){return this.inputElement.value},createListItem:function(t,e,i){return new Element("li",{text:e,"data-value":t,style:i||""})}}),PushWidgets.WFSelect.attach=function(t){t=t||n.body,$(t).getElements("form select:not([multiple])").each(function(t){new PushWidgets.WFSelect(t),t.set("data-ui-role",null)})}}(window,document);