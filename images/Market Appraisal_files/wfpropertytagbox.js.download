!function(i,n){"use strict";PushWidgets.PropertyTagBox=new Class({Implements:[Events,Options],Binds:["keydownEvent","blurEvent","focusEvent","keyupEvent","getSuggestions","positionDropdown","createListItem"],options:{maxTags:10,grabFocus:!0,className:"tagbox",action:null,param:"search",method:"get",minlength:0},inputElement:null,entryElement:null,parentForm:null,wrap:null,id:null,tags:[],dropdownList:null,xhrInstance:null,cache:[],initialize:function(t,e){if(this.setOptions(e),void 0===t||"input"!=t.tagName.toLowerCase())return!1;t.hasAttribute("data-setup-options")&&this.setOptions(JSON.parse(t.getAttribute("data-setup-options"))),this.inputElement=t.set("type","hidden"),this.parentForm=this.inputElement.getParent("form"),this.id=this.inputElement.get("id"),this.wrap=new Element("div",{id:this.id,class:this.options.className,styles:{position:"static",overflow:"visible",height:"auto"}}).wraps(this.inputElement),this.entryElement=new Element("input",{type:"text",placeholder:this.options.placeholder||this.inputElement.get("placeholder")||"",autocomplete:"off",class:t.get("class")}).inject(this.wrap),this.options.grabFocus&&this.entryElement.focus(),this.setValues(this.inputElement.get("value")),this.inputElement.removeAttribute("id"),this.dropdownList=new Element("ul",{class:this.options.className+"-listbox",styles:{display:"none"}}).inject(this.wrap,"bottom"),this.dropdownList.addEvent("mousedown:relay(li[data-type])",function(t,e){this.chooseItem(e)}.bind(this)),this.positionDropdown(!1),this.dropdownList.addEvent("mouseenter:relay(li[data-type])",function(t,e){e.getSiblings().removeClass("selected"),e.addClass("selected")}),this.dropdownList.addEvent("mouseleave:relay(li[data-type])",function(t,e){e.removeClass("selected")}),this.wrap.addEvent("click:relay(."+this.options.className+"-item>span)",function(t,e){e=e.getParent();this.tags.erase(e),e.destroy(),this.updateValue(),this.fireChangeEvents()}.bind(this)),this.entryElement.addEvent("keydown",this.keydownEvent),this.entryElement.addEvent("keyup",this.keyupEvent),this.entryElement.addEvent("blur",this.blurEvent.debounce(200,!1)),this.entryElement.addEvent("focus",this.focusEvent.debounce(150,!1)),this.entryElement.addEvent("dblclick",this.getSuggestions),this.entryElement.addEvent("click",this.getSuggestions),i.addEvent("resize",this.positionDropdown)},keydownEvent:function(t){if(this.tags.length>=this.options.maxTags&&!["backspace","tab","enter"].contains(t.key))t.preventDefault();else if("enter"!=t.key||this.dropdownList.isVisible()||""==this.entryElement.get("value")||t.preventDefault(),!this.dropdownList.isVisible()&&this.tags.length>=this.options.maxTags&&!["backspace","enter"].contains(t.key))t.preventDefault();else{var e;if(["down"].contains(t.key)&&(t.stopPropagation(),t.preventDefault(),this.dropdownList.isVisible()||this.getSuggestions()),this.dropdownList.isVisible()&&["up","down","enter"].contains(t.key)&&((e=this.selectItem(t.key))?this.entryElement.set("value",e.get("text")):this.entryElement.set("value",""),this.dropdownList.isVisible()&&("enter"==t.key&&this.chooseItem(e),t.stop())),"esc"==t.key)return this.chooseItem(null),!1;""==this.entryElement.value&&"backspace"==t.key&&0<this.tags.length&&(this.tags.pop().destroy(),this.updateValue(),this.fireChangeEvents())}},keyupEvent:function(t){["down","space"].contains(t.key)&&(t.stopPropagation(),t.preventDefault(),this.dropdownList.isVisible()||this.getSuggestions()),["up","down","left","right","tab","enter","esc","shift","ctrl"].contains(t.key)||this.getSuggestions()},blurEvent:function(){this.wrap.removeClass("focus"),this.positionDropdown(!1)},focusEvent:function(){this.wrap.addClass("focus")},chooseItem:function(t){null!==t&&this.addTag(t.get("text"),JSON.parse(t.get("data"))),this.entryElement.set("value",""),this.dropdownList.setStyle("display","none"),this.updateValue(),this.fireChangeEvents(),this.entryElement.focus()},updateValue:function(){var e=[];this.tags.each(function(t){e.push(t.get("data-type")+":"+t.get("text"))}),this.inputElement.set("value",e.join("; "))},fireChangeEvents:function(){this.fireEvent("change"),this.parentForm.fireEvent("change")},addTag:function(e,t){e&&!this.tags.some(function(t){return t.get("text")==e})&&(t=new Element("div",{text:e,"data-type":t.type,class:this.options.className+"-item ",title:e}),new Element("span",{text:"",class:this.options.className+"-item-delete"}).inject(t,"bottom"),this.tags.push(t),t.inject(this.entryElement,"before"))},selectItem:function(e){var s=!1,i=this.dropdownList.getChildren("[data-type]");if(0==i.length)return!1;if(1==i.length)return i[0];if("esc"==e)return null;i.each(function(t){!s&&t.hasClass("selected")&&("up"==e&&(t.removeClass("selected"),s=null===t.getPrevious("[data-type]")?t||i.getFirst("[data-type]"):t.getPrevious("[data-type]")),"down"==e&&(t.removeClass("selected"),s=null===t.getNext("[data-type]")?t||i.getFirst("[data-type]"):t.getNext("[data-type]")),"tab"!=e&&"enter"!=e||(s=t))}),(s=s||i[0]).addClass("selected");var t=s.getPosition().y-this.dropdownList.getPosition().y+this.dropdownList.getScroll().y;return t<this.dropdownList.getHeight()-s.getHeight()?t<this.dropdownList.getHeight()/2?this.dropdownList.scrollTo(0,0):this.dropdownList.scrollTo(0,t-s.getHeight()):t>this.dropdownList.getHeight()-s.getHeight()&&this.dropdownList.scrollTo(0,t-2*s.getHeight()),s},getSuggestions:function(){this.entryElement.value.length>=this.options.minlength&&this.tags.length<this.options.maxTags?(null!==this.xhrInstance&&this.xhrInstance.setOptions({url:this.options.action}),this.suggestions&&this.suggestions[0]==this.entryElement.get("value").trim()||(this.cache[this.options.action+"::"+this.entryElement.get("value").trim()]?this.showSuggestions(this.cache[this.options.action+"::"+this.entryElement.get("value").trim()]):(null===this.xhrInstance&&(this.xhrInstance=new Request.JSON({url:this.options.action,method:this.options.method,onSuccess:function(t){this.suggestions=t,this.cache[this.entryElement.get("value").trim()]=t,this.showSuggestions(this.suggestions)}.bind(this)})),this.xhrInstance.send(this.options.param+"="+this.entryElement.get("value").trim())))):(this.dropdownList.empty(),this.positionDropdown(!1))}.debounce(200,!1),showSuggestions:function(e){this.dropdownList.empty(),0<Object.keys(e).length?(Object.keys(e).forEach(function(t){this.createHeaderItem(t).inject(this.dropdownList,"bottom"),e[t].each(function(t){this.createListItem(t).inject(this.dropdownList,"bottom")}.bind(this))}.bind(this)),this.dropdownList.getFirst("[data-type]").addClass("selected"),this.positionDropdown(!0),this.dropdownList.scrollTo("top"),this.dropdownList.setStyle("display","block"),this.dropdownList.scrollTo(0,0)):this.dropdownList.setStyle("display","none")},positionDropdown:function(t){var e=this.wrap.getBoundingClientRect(),s=this.dropdownList.measure(function(){return this.getSize()});this.dropdownList.setStyle("width",e.width+"px"),e.top+e.height+s.y<(i.innerHeight||n.documentElement.clientHeight)?this.dropdownList.position({relativeTo:this.wrap,position:"bottomLeft",edge:"topLeft"}):this.dropdownList.position({relativeTo:this.wrap,position:"topLeft",edge:"bottomLeft"}),t?this.dropdownList.setStyles({display:"block",visibility:"visible"}):this.dropdownList.setStyles({display:"none",visibility:"hidden"})},setValues:function(t){!t||0==t.length||1==t.length&&""==t[0]||(t=t.trim().split(";")).forEach(function(t){var e=t.trim().split(":",2),t={text:e[1],type:e[0]};this.addTag(e[1],t)}.bind(this))},setValue:function(t){this.tags.each(function(t){t.destroy()}),this.tags.empty(),this.inputElement.set("value",""),this.setValues(t),this.updateValue()},getValue:function(){return this.inputElement.get("value")},createListItem:function(t){var e=this.entryElement.get("value"),s=Object.clone(t),t=s.text;return delete s.text,new Element("li",{html:t.replace(new RegExp(e,"i"),"<mark>"+t.substr(t.toLowerCase().indexOf(e.toLowerCase()),e.length)+"</mark>"),data:JSON.stringify(s),"data-type":s.type,title:s.text})},createHeaderItem:function(t){return new Element("li",{html:t,class:"header"})}}),PushWidgets.PropertyTagBox.attach=function(t){t=t||n.body,$(t).getElements('[data-ui-role="propertytagbox"][data-setup-options]').each(function(t){new PushWidgets.PropertyTagBox(t),t.set("data-ui-role",null)})}}(window,document);